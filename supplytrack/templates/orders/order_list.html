{% extends 'base.html' %}
{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/orders/orders.css' %}">
{% endblock %}

{% block content %}
<h1 class="section-title">Orders</h1>

<div class="order-layout">
    <div class="order-panel">
        <div class="table-actions">
            <input type="text" class="search-input" placeholder="Search orders..." />
            <div class="button-group">
                <button class="action-btn create-btn" onclick="openOrderModal()">Add Order</button>
                <button class="action-btn update-btn" onclick="openUpdateForm()">Update</button>
                <button class="action-btn delete-btn">Delete Order</button>
            </div>
        </div>

        <div class="table-wrapper">
            <table class="order-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all" /></th>
                        <th>Order ID</th>
                        <th>Product ID</th>
                        <th>Product Name</th>
                        <th>Quantity</th>
                        <th>Order Date</th>
                        <th>Expected Delivery</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr data-order-id="{{ order.order_id }}" data-product-pk="{{ order.product.id }}">
                        <td><input type="checkbox" class="order-checkbox" /></td>
                        <td>{{ order.order_id }}</td>
                        <td>{{ order.product.product_id }}</td>
                        <td>{{ order.product.name }}</td>
                        <td>{{ order.quantity }}</td>
                        <td>{{ order.order_date|date:"Y-m-d H:i" }}</td>
                        <td>{{ order.expected_delivery }}</td>
                        <td>{{ order.status }}</td>
                    </tr>
                    {% endfor %}
                </tbody>                
            </table>
        </div>
    </div>

    <!-- Modal Form -->

    <div id="orderModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" onclick="closeOrderModal()">&times;</span>
            <h2 id="modalTitle">Add Order</h2>
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="order_id" id="hidden-order-id">  <!-- ✅ here -->
                {{ form.as_p }}
                <button type="submit" class="submit-btn">Save Order</button>
            </form>                                  
        </div>
    </div>



<script>
    function openOrderModal() {
        document.getElementById("orderModal").classList.remove("hidden");
    }
    
    function closeOrderModal() {
        document.getElementById("orderModal").classList.add("hidden");
        document.getElementById("hidden-order-id").value = "";
        document.getElementById("modalTitle").textContent = "Add Order";
        document.querySelector('.submit-btn').textContent = "Save Order";
    }
    
    function openUpdateForm() {
        const selected = document.querySelectorAll('.order-checkbox:checked');
        if (selected.length !== 1) {
            alert("Select exactly one order to update.");
            return;
        }
    
        const row = selected[0].closest('tr');
        const orderId = row.children[1].textContent.trim();
        const productPk = row.getAttribute("data-product-pk");
        const quantity = row.children[4].textContent.trim();
        const expectedDeliveryText = row.children[6].textContent.trim();
        const status = row.children[7].textContent.trim();
    
        document.getElementById('hidden-order-id').value = orderId;
        document.querySelector("select[name='product']").value = productPk;
        document.querySelector("input[name='quantity']").value = quantity;
    
        if (expectedDeliveryText) {
            const parsedDate = new Date(expectedDeliveryText);
            const yyyy = parsedDate.getFullYear();
            const mm = String(parsedDate.getMonth() + 1).padStart(2, '0');
            const dd = String(parsedDate.getDate()).padStart(2, '0');
            document.querySelector("input[name='expected_delivery']").value = `${yyyy}-${mm}-${dd}`;
        }
    
        document.querySelector("select[name='status']").value = status;
        document.getElementById("modalTitle").textContent = "Update Order";
        document.querySelector('.submit-btn').textContent = "Update Order";
        openOrderModal();
    }    
          
    document.querySelector('.delete-btn').addEventListener('click', function () {
        const checked = document.querySelectorAll('.order-checkbox:checked');
        if (!checked.length) {
            alert("Select orders to delete.");
            return;
        }

        if (!confirm("Delete selected orders?")) return;

        // ✅ Collect order_id from data attribute (NOT database id)
        const ids = Array.from(checked).map(cb => cb.closest('tr').dataset.orderId);

        fetch("{% url 'orders:delete_orders' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ids })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                location.reload();  // ✅ Refresh the page if successful
            } else {
                alert("Delete failed: " + (data.error || "Unknown error"));  // Show error if available
            }
        })
        .catch(err => {
            alert("An unexpected error occurred: " + err.message);
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        const selectAllCheckbox = document.getElementById("select-all");

        selectAllCheckbox.addEventListener("change", function () {
            const checkboxes = document.querySelectorAll(".order-checkbox");
            checkboxes.forEach(cb => cb.checked = this.checked);
        });
    });
</script>
{% endblock %}
